---
title: "FinalAnalysis"
author: "Shengtong"
date: "July 25, 2018"
output: html_document
---

<!-- The file analysis/chunks.R contains chunks that define default settings
shared across the workflowr files. -->
```{r read-chunk, include=FALSE}
knitr::read_chunk("chunks.R")
library(knitr)
library(kableExtra)
library(RColorBrewer)
library(gplots)
set.seed(123)
```


## 48ng 5hmC 

### Overlap by Venn diagram 

If we combine eleven 48ng 5hmC samples together, there are 2367316 20bp windows with FDR 0.05, of  which 686652 windows are overlapping with strong TAB-seq windows which are extended 10 bp downtream and 10 bp upstream. for strong TAB-seq, there are 2057636 20bp extended windows and 763937 are overlapping with Jump-seq windows.   



![ Venn diagram of 5hmC and TAB-seq. 48ng samples are combined together and 20 bp windows are called at FDR 0.05. The proportion of peak windows of jump-seq overlapping with TAB-seq and the proportion of peaks of TAB-seq overlapping with jump-seq are presented inside the circle.  ](figure/VennDiagram.png)



If we combine eleven 48ng 5hmC samples together, there are 2367316 20bp windows with FDR 0.05, of  which 386331 (16.32%) windows are overlapping with hmC seal. For hmC seal,  there are 64865 peaks and 58280 (89.85%) are overlapping with 5hmC peaks. 

![ Venn diagram of 5hmC and hmC-seal. 48ng samples are combined together and 20 bp windows are called at FDR 0.05. The proportion of peak windows of jump-seq overlapping with hmC-seal  and the proportion of peaks of hmC-seal overlapping with jump-seq are presented inside the circle. ](figure/VennDiagram_hmc_hmcseal.png)


### Sensitivity 


```{r, echo=F, fig.cap="This figure presents the proportion of peak windows of TAB-seq and hmC-seal that are recovered by 20 bp jump-seq peak windows from 48ng combined sample with FDR at 0.05"}
ratio=matrix(nrow=2, ncol=2)
ratio[,1]=c(0.8985, 0.3713)
ratio[,2]=c(0.8985, 0.3713)
ave=matrix(nrow=2, ncol=1)
ave[,1]=rowMeans(ratio)
rownames(ave)=c("hmC-seal", "TAB-seq")
#pdf("D:\\Dropbox\\JumpSeqProject\\Figure\\sensitivity_48ng_11sampleCombined.pdf")
barplot(ave[,1], beside=F, ylim=c(0,1.2), col=c("red", "darkblue"), xlab=c(""), main="", ylab="Sensitivity")
text(0.6, 1.0, ave[1])
text(2, 0.45, ave[2])
#dev.off()
```

 


### Enrichment in genomic regions

```{r, echo=F, fig.cap=" Eleven 48 ng samples are combined together and 20 bp peak windows are called at FDR 0.05. Random windows are randomly selected  in the whole genome with the same amount of peak windows. The proportion of chosen peak windows (red) and random windows (blue) overlapping in  different genomic regions are calculated and the corresponding odds ratio are shown above the red bar"}
minus.percent=matrix(nrow=2, ncol=5)
minus.percent[,1]=c(0.0070, 0.0032)
minus.percent[,2]=c(0.0139, 0.0034)

minus.percent[,3]=c(0.0069, 0.0026)
minus.percent[,4]=c(0.0042, 0.0021)

minus.percent[,5]=c(0.0005, 0.0011)
colnames(minus.percent)=c("ctcf", "enhancer", "h3k27ac", "h3k4me3", "polII")

plus.percent=matrix(nrow=2, ncol=5)
plus.percent[,1]=c(0.0068, 0.0032)
plus.percent[,2]=c(0.0139, 0.0034)

plus.percent[,3]=c(0.0070, 0.0026)
plus.percent[,4]=c(0.0042, 0.0021)

plus.percent[,5]=c(0.0006, 0.0011)
colnames(plus.percent)=c("ctcf", "enhancer", "h3k27ac", "h3k4me3", "polII")
ave.percent=(minus.percent+plus.percent)/2


#pdf("D:\\Dropbox\\JumpSeqProject\\Figure\\Enrichment_different_region_48ng_11sampleCombined_FDR0.05.pdf")
barplot(ave.percent, beside=T, col=c("red", "darkblue"), legend=c("Jump-seq peaks", "Random windows"), ylim=c(0,0.02),
ylab="Proportion of Jump-seq windows", main="", xlab="", cex.names=1)
text(1.5, 0.008, "2.16")
text(4.5, 0.015, "4.09")
text(7.5, 0.008, "2.67")
text(10.5, 0.005, "2.00")
text(14, 0.002, "0.50")
#dev.off()
```


## Enrichments across different genomic concentrations

```{r, echo=F, fig.cap=" From 0.6ng to  48ng 5hmC samples, 20bp peak windows are called at FDR 0.05 for jump-seq. Random windows are chosen in the whole genome in the same amount of peak windows. The overlap of peak windows by jump-seq and random windows with peaks from TAB-seq and hmC-seal are colored in red and blue respectively. "}
percent=matrix(nrow=2, ncol=12)
percent[,1]=c(0.0854,0.0194)
percent[,2]=c(0.1382,0.0257)

percent[,3]=c(43213, 10092)/521062
percent[,4]=c(98049, 13382)/521062

percent[,5]=c(61404, 12907)/665737
percent[,6]=c(114794, 17049)/665737

percent[,7]=c(111734, 23171)/1197291
percent[,8]=c(149717, 31057)/1197291

percent[,9]=c(122190, 28799)/1474825
percent[,10]=c(246529, 37851)/1474825

percent[,11]=c(529216, 73689)/3789453
percent[,12]=c(921479, 98580)/3789453
colnames(percent)=rep(c("0.6ng", "2.4ng", "6ng", "12ng", "24ng", "48ng"), each=2)

par(mfrow=c(1,2))
barplot(percent[,c(1,3,5,7,9, 11)], beside=T, col=c("red", "darkblue"), legend=c("Jump-seq peaks", "Random windows"), ylim=c(0,0.3),
xlab="A", main="", ylab="Proportion of hmC-seal peaks", cex.names=0.5)

barplot(percent[,c(2,4,6,8,10, 12)], beside=T, col=c("red", "darkblue"), legend=c("Jump-seq peaks", "Random windows"), ylim=c(0,0.4),
xlab="B", main="", ylab="Proportion of TAB-seq peaks", cex.names=0.5)
```


* FDR 0.05 is used for determine peak windows and sated clearly otherwise 
* To make fair comparison, in each case, the same amount of random windows as peak windows  are picked in the whole genome and compute the its proportion windows overlpping with peaks from other methods. 
* In some case, sinlge sample was used and in some cases, may be combined samples are used, but the enrichments are similar in both cases. 



##  reads count and abundance 


```{r, echo=F, fig.cap="The fitted regression line (red) on the fold change of number of reads (point) at different hmC proportions in spike in"}
hmc.ratio=c(0, 0.01, 0.05,  0.25, 0.5, 0.75, 1)
num.reads.plus1=c(34536, 103817, 282178, 1374788, 2427158, 3002380, 3198060)

fit=lm(num.reads.plus1/num.reads.plus1[1] ~ hmc.ratio)

#pdf("D:\\Dropbox\\JumpSeqProject\\Figure\\spike.in.regression.pdf")
plot(hmc.ratio, num.reads.plus1/num.reads.plus1[1], xlim=c(0,1), ylim=c(0, 110), type="p", ylab="Fold change of reads count", xlab="Proportion of hmC", xaxt="n", main="", pch=16)
axis(1, at =hmc.ratio, las=0, cex.axis=0.5)
lines(hmc.ratio, fit$coefficients[1]+fit$coefficients[2]*hmc.ratio, col=2, type="l")
r.square=summary(fit)$r.squared
legend(0.01,100, expression(paste(R^2, "=0.94")))
#dev.off()

#legend(0.75, 40, c("observed", "fitted"), col=c(1,2), lty=c(1,1))
```


## 0.6ng 5hmC 

## enrichment in genomic regions 

```{r, echo=F, fig.cap="For 0.6ng 5hmC sample, 20 bp windows with at least one reads are called peak windows. Random windows are chosen in the whole genome in the same amount of peak windows. The proportion of peak windows and random windows in different genomic regions (200bp bins) are computeed. "}
percent=matrix(nrow=2, ncol=5)
percent[,1]=c(0.0049, 0.0032)
percent[,2]=c(0.0056, 0.0035)

percent[,3]=c(0.0033, 0.0026)
percent[,4]=c(0.0021, 0.0021)

percent[,5]=c(0.0034, 0.0012)
colnames(percent)=c("ctcf", "enhancer", "h3k27ac", "h3k4me3", "polII")

barplot(percent, beside=T, col=c("red", "darkblue"), legend=c("Jump-seq peaks", "Random windows"), ylim=c(0,0.01),
ylab="Proportion of Jump-seq windows", main="", xlab="", cex.names=1)
```

* cis-regulatory regions are extended 200bp windows. 
* jump peaks are 20 bp windows with at least one reads. 


### Reads overlap with single 48ng sample 

0.6ng: 1085 20 bp windows of 21188 


## 5mC 



### Enrichment

```{r, echo=F, fig.cap="Enrichment of methylated cytosine from Gary Hon  at different genomic concentrations. Peak windows with p value less than 10^{-6} is used for 48ng, 24ng, 12ng, 6ng and FDR0.05 is used for 2.4ng. "}
minus.percent=matrix(nrow=2, ncol=5)
minus.percent[,1]=c(0.7895, 0.1450)
minus.percent[,2]=c(0.8069, 0.1450)
minus.percent[,3]=c(0.8051, 0.1450)
minus.percent[,4]=c(0.8511, 0.1450)
minus.percent[,5]=c(0.8374, 0.1450)
colnames(minus.percent)=c("2.4ng", "6ng", "12ng", "24ng", "48ng")

plus.percent=matrix(nrow=2, ncol=5)
plus.percent[,1]=c(0.7826, 0.1450)
plus.percent[,2]=c(0.8473, 0.1450)
plus.percent[,3]=c(0.8355, 0.1450)
plus.percent[,4]=c(0.8482, 0.1450)
plus.percent[,5]=c(0.8403, 0.1450)
colnames(plus.percent)=c("2.4ng", "6ng", "12ng", "24ng", "48ng")
percent=(plus.percent+minus.percent)/2
#pdf("D:\\Dropbox\\JumpSeqProject\\Figure\\Enrichemnt_5mC.pdf")
barplot(percent, beside=T, col=c("red", "darkblue"), legend=c("Jump-seq peaks", "Random windows"), ylim=c(0,1.2),
ylab="Proportion of Jump-seq windows", main="", xlab="", cex.names=0.7)
#dev.off()
```


* cutoff used for peak windows: 2.4ng (FDR0.05), others use p values less than $10^{-6}$. 




### Sensitivity 


```{r, echo=F, fig.cap="Normalized proportion of  methylated cytosine from Gary Hon  at different genomic concentrations recovered by Jump-seq. Peak windows with p value less than 10^{-6} is used for 48ng, 24ng, 12ng, 6ng and FDR0.05 is used for 2.4ng"}
percent=matrix(nrow=2, ncol=5)
percent[,1]=c(0.000026, 0.000029)
percent[,2]=c(0.000195, 0.000334)
percent[,3]=c(0.000313, 0.000553)
percent[,4]=c(0.000503, 0.000704)
percent[,5]=c(0.000776, 0.000786)
colnames(percent)=c("2.4ng", "6ng", "12ng", "24ng", "48ng")
col.mean=colMeans(percent)
normalized.mean=col.mean/max(col.mean)
barplot(normalized.mean, col="darkblue", ylab="Normalized proportion of methylated cytosine")
```


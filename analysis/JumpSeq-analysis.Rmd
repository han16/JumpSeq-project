---
title: "Jump seq data analysis"
author: "Shengtong Han"
date: YYYY-MM-DD
output: html_document
---

<!-- The file analysis/chunks.R contains chunks that define default settings
shared across the workflowr files. -->
```{r read-chunk, include=FALSE, cache=FALSE}
knitr::read_chunk("chunks.R")
```

<!-- Update knitr chunk options -->
```{r knitr-opts-chunk, include=FALSE}
```

<!-- Insert the date the file was last updated -->
```{r last-updated, echo=FALSE, results='asis'}
```

<!-- Insert the code version (Git commit SHA1) if Git repository exists and R
 package git2r is installed -->
```{r code-version, echo=FALSE, results='asis'}
```

<!-- Add your analysis here -->

All samples are [here][allsample]: 48 ng (11); 24 ng (5); 12 ng (5); 6ng (5); 2.4 ng (5); 0.6ng (2). 

[allsample]: https://docs.google.com/spreadsheets/d/1WesFCQTrFplnXRKCHmhqtm1529DHc5Sc2tX7GkRa_-U/edit#gid=1664366512


##  48ng 5hmC replicates

### Summary 
There are eleven 48ng 5hmC replicates(see [here][5hmc]). Each one has two strands, plus+minus. 

[5hmc]: https://docs.google.com/spreadsheets/d/1FHkVSgTCJDY19VcFg2goat4rXJfxofCn3CFRV-gCbfo/edit#gid=400442004


rep  | 1 |2 | 3 | 4 | 5| 6| 7| 8| 9| 10| 11 
-----|---|---|---|---|---|---|---|---|---|---|-----------
\#reads(plus) |3,516,149|3,781,024|2,014,714|6,982,592|4,741,743|5,036,004|5,825,862|5,532,109|5,072,780|3,951,163|3,641,213|
\#reads(minus)|3,524,627| 3,793,291|2,021,689|6,995,038|4,754,910 |5,048,479|5,834,324|5,546,279|5,059,828|3,935,679|3,631,379|
Table: Number of reads in plus and minus strand for each 48 ng replicate. 

### Two large combined replicates from eleven 48 ng 5hmC replicates
Once the base level coverage of each individual replicates is obtained, directly combine some of them to form a synthesized large replicate and the rest form to another such that their coverage, i.e. number of reads are as balanced as possible. In this way, power is expected to be increasing. 

* combined rep 1: rep 4+5+6+7+8
* combined rep 2:rep 1+2+3+9+10+11

Two large combined replicates | \#reads
------------------------------|-----------
rep1.minus | 28,179,030 
rep1.plus | 28,118,310
rep2.minus | 21,966,493
rep2.plus | 21,977,043
rep1+rep2:minus| 50,145,523
rep1+rep2:plus | 50,095,353
Table: Number of reads in each combined replicate. 

##### Comparison with Dali Han's data
Originally called 20 bp windows are extended by 2kbp, 1kbp upstream and 1kbp downstream. Overlapping between extended peak windows (at four p value cutoffs $10^{-3}, 10^{-7}, 10^{-15}, 10^{-20}$) and Dali Han's data (window size differs among each other) are summzried below. 

Combined replicate | \#overlap.win | \#.win | ratio
-------------------|---------------|--------|------
rep1.minus.21.bp.enriched.window.p10-3.bed.extend2kbp.bed | 345920 | 1318454 | 0.2623679
rep1.minus.21.bp.enriched.window.p10-7.bed.extend2kbp.bed | 74515 | 236507 | 0.3150647
rep1..minus.21.bp.enriched.window.p10-15.bed.extend2kbp.bed | 9191 | 27656 | 0.3323329
rep1.minus.21.bp.enriched.window.p10-20.bed.extend2kbp.bed | 3686 | 11162 | 0.3302276
rep1.plus.21.bp.enriched.window.p10-3.bed.extend2kbp.bed | 344905 | 1317670 | 0.2617537
rep1.plus.21.bp.enriched.window.p10-7.bed.extend2kbp.bed | 74504 | 236568 | 0.3149369
rep1.plus.21.bp.enriched.window.p10-15.bed.extend2kbp.bed | 9167 | 27662 | 0.3313932
rep1.plus.21.bp.enriched.window.p10-20.bed.extend2kbp.bed | 3554 | 10997 | 0.3231790
rep2:minus.21.bp.enriched.window.p10-3.bed.extend2kbp.bed | 349863 | 1245093 | 0.2809935
rep2:minus.21.bp.enriched.window.p10-7.bed.extend2kbp.bed | 70615 | 199358 | 0.3542120
rep2:minus.21.bp.enriched.window.p10-15.bed.extend2kbp.bed | 8216 | 21511 | 0.3819441
rep2:minus.21.bp.enriched.window.p10-20.bed.extend2kbp.bed | 2851 | 7710 | 0.3697795
rep2:plus.21.bp.enriched.window.p10-3.bed.extend2kbp.bed | 348193 | 1243355 | 0.2800431
rep2:plus.21.bp.enriched.window.p10-7.bed.extend2kbp.bed | 71014 | 200017 | 0.3550398
rep2:plus.21.bp.enriched.window.p10-15.bed.extend2kbp.bed | 8769 | 22941 | 0.3822414
rep2:plus.21.bp.enriched.window.p10-20.bed.extend2kbp.bed | 2792 | 7557 | 0.3694588
Table: Comparison of peak windows between two large replivcates and Dali's data. 

##### Comparison between two large replicates 


minus | $10^{-1}$| $10^{-3}$ | $10^{-5}$ |$10^{-7}$ | $10^{-15}$ | $10^{-20}$
------|----------|-|-----------|------------|-------------|--
rep1 | 0.9905  |0.9388 | 0.8425 |0.7334 | 0.4543 | 0.4056
rep2 |0.9886 | 0.9523 |  0.8961 |0.8091 | 0.5576 | 0.5612
plus |$10^{-1}$| $10^{-3}$ | $10^{-5}$|$10^{-7}$ | $10^{-15}$ | $10^{-20}$
rep1 | 0.9906 | 0.9389 | 0.8426 |0.7337 | 0.4650 | 0.3952
rep2 |0.9887 | 0.9524 | 0.8967 |0.8095 | 0.5397 | 0.5419
Table: Overlapping among peak windows extended by 2kbp for 2 large combined replicates at different p value cutoffs.


Surprisingly, the overlapping rate deceases as the p value cutofff becomes more stringent. 



minus | 0.5| 0.1 | 0.01|0.001 | 0.0001 |$10^{-7}$ |$10^{-10}$
------|----------|-|-----------|------------|----|-----|---
rep1 |0.3955| 0.4118 | 0.3840 | 0.3611| 0.3563| 0.3148 |0.3118
rep2 |0.4985 | 0.3915  |  0.4111 |0.4109 | 0.4023| 0.4196| 0.4231
plus |0.5| 0.1 | 0.01|0.001 | 0.0001 | $10^{-7}$ |$10^{-10}$
rep1 | 0.3954 | 0.4126 | 0.3841 |0.3627 | 0.3572 | 0.3991|0.3115
rep2 |0.4985 | 0.3907 | 0.4116 |0.4128 | 0.4030 | 0.4205| 0.4205
Table: overlapping for originally called 20 bp windows at different FDR levels.

### Downsample
Combine all 48ng replicates together, downsample $40\%, 50\%, \cdots, 90\%$ reads, call peak windows, and see how \#peak.windows (absolute peak windows or overlapping with other data) vary with number of reads.   

```{r, engine = 'bash', eval = FALSE}
samtools merge output.sorted.bam input1.sorted.bam input2.sorted.bam # merge together sorted bam files
```

```{r, engine='bash', eval=F}
samtools view -s 0.25 -b input.all.bam > input_25p.sam # downsample 25% reads 
```

ratio  | plus | minus 
-------|------|-----
40\% |20,027,749 |20,070,771
50\% |25,029,777 |25,091,279
60\% |30,035,435 |30,110,375
70\% |35,040,232|35,127,703
80\% |40,044,961 |40,149,113
90\% |45,048,466 |45,168,687
Table: Actutrally number of reads from each downsample with ratios of  $40\%, 50\%, \cdots, 90\%$. 

For each down sample, call base level coverage, call peak windows and count how many peak windows at specified FDR level. 

```{r, echo=T,  eval =T}
num.win.FDR5per=c(1848560, 2149967, 2635168, 2738080, 3066015, 3458501)
num.reads=c(20070771, 25091279, 30110375, 35127703, 40149113, 45168687)
plot(num.reads, num.win.FDR5per, xlab="Number of reads", ylab="# peak windowsof 20 bp at FDR0.05", type="o", main="minus strands")
```

```{r, echo=T,  eval =T}
num.win.FDR5per=c(1854249, 2148405, 2632652, 2736153, 3082261, 3456391)
num.reads=c(20027749, 25029777, 30035435, 35040232, 40044961, 45048466)
plot(num.reads, num.win.FDR5per, xlab="Number of reads", ylab="# peak windowsof 20 bp at FDR0.05", type="o", main="plus strands")
```

**Based on the current observations, the number of peak windows grows as the read coverage increases, it does not show significant plateau**. 


## 24ng 5hmC replicate
## 12ng 5hmC replicate

## 6ng 5hmC replicate 
## 2.4ng 5hmC replicate
There are 4 replicates (see [here][2.4ng]). 

[2.4ng]: https://docs.google.com/spreadsheets/d/1FHkVSgTCJDY19VcFg2goat4rXJfxofCn3CFRV-gCbfo/edit#gid=400442004


## 0.6ng 5hmC replicate

## Session information

<!-- Insert the session information into the document -->
```{r session-info}
```
